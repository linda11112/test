<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thiên Mệnh Chi Tỷ Lý Huynh - Realtime RPG (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        
        // *******************************************************************
        // * BƯỚC QUAN TRỌNG: DÁN URL GOOGLE APPS SCRIPT WEB APP CỦA BẠN VÀO ĐÂY *
        // *******************************************************************
        const GOOGLE_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxFCSjgriQVaI1AiZHglN1rBopiNNgLBXqi1FFpJTqHDqOnHXs2L2rFAqJ1BjTT3gdJ/exec'; 
        
        // Khai báo biến ID người chơi (sẽ được gán sau khi đăng nhập)
        window.gameState = window.gameState || {};
        window.gameState.playerId = null;
        window.gameState.username = null; // Thêm tên người dùng để hiển thị

        // --- NEW API & SAVE/LOAD FUNCTIONS (Google Sheets) ---

        window.apiCall = async function(action, payload) {
            const statusDiv = document.getElementById('login-status') || document.getElementById('game-console');
            try {
                if (statusDiv.id === 'login-status') {
                    statusDiv.textContent = `•API: Đang gửi yêu cầu ${action}...`;
                } else {
                    window.logToConsole(`•API: Đang gửi yêu cầu ${action}...`);
                }

                const response = await fetch(GOOGLE_APP_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action, ...payload }),
                    headers: { 'Content-Type': 'text/plain' } // Cần thiết cho Apps Script
                });
                const result = await response.json();
                
                if (result.success) {
                    if (statusDiv.id === 'login-status') statusDiv.textContent = '';
                    return result;
                } else {
                    if (statusDiv.id === 'login-status') {
                        statusDiv.textContent = `§LỖI: ${result.message}`;
                    } else {
                        window.logToConsole(`§LỖI SERVER: ${result.message}`);
                    }
                    return null;
                }
            } catch (e) {
                console.error("Lỗi kết nối API:", e);
                if (statusDiv.id === 'login-status') {
                    statusDiv.textContent = "§LỖI KẾT NỐI: Không thể liên lạc với máy chủ Tu Tiên.";
                } else {
                    window.logToConsole("§LỖI KẾT NỐI: Không thể liên lạc với máy chủ Tu Tiên.");
                }
                return null;
            }
        }

        // Thay thế hàm loadGame cũ
        window.loadGame = async function() {
            if (!gameState.playerId) return null;

            const result = await window.apiCall('LOAD_GAME', { id: gameState.playerId });
            if (result && result.saveData) {
                try {
                    return JSON.parse(result.saveData);
                } catch (e) {
                    console.error("Lỗi parse JSON SaveData:", e);
                    window.logToConsole("§LỖI: Dữ liệu lưu trữ bị lỗi, tạo nhân vật mới.");
                    return null;
                }
            }
            return null; // Không tìm thấy dữ liệu hoặc lỗi
        };

        // Thay thế hàm saveGame cũ (sử dụng LocalStorage)
        window.saveGame = async function(state) {
            if (!gameState.playerId) {
                return window.logToConsole("§LỖI: Chưa đăng nhập, không thể lưu game lên server.");
            }
            
            // Loại bỏ các interval và biến tạm thời không cần lưu
            const stateToSave = { ...state };
            delete stateToSave.tuXianInterval; 
            delete stateToSave.combatInterval;
            delete stateToSave.npcCombatInterval;
            delete stateToSave.timeTickInterval;
            delete stateToSave.healthRegenInterval;
            delete stateToSave.currentMonster; 
            delete stateToSave.currentNPCCombat;
            
            const payload = { 
                id: gameState.playerId,
                saveData: JSON.stringify(stateToSave) 
            };
            const result = await window.apiCall('SAVE_GAME', payload);
            if (result) {
                window.logToConsole("•ĐÃ LƯU: Tiến trình Tu Luyện đã được lưu lên Server.");
            }
        };

        // Hàm xử lý nút Lưu Trữ Tiến Trình
        window.handleActionSave = function() {
            window.saveGame(gameState);
        };
        
        // --- LOGIC ĐĂNG NHẬP / TẠO TÀI KHOẢN ---
        window.handleActionLogin = async function() {
            const username = document.getElementById('username-input').value;
            const password = document.getElementById('password-input').value;
            
            const result = await window.apiCall('LOGIN', { username, password });
            
            if (result && result.id) {
                document.getElementById('login-status').textContent = 'Đăng nhập thành công! Đang tải dữ liệu...';
                window.startGameSession(result.id, username);
            } 
        };

        window.handleActionCreateAccount = async function() {
            const username = document.getElementById('username-input').value;
            const password = document.getElementById('password-input').value;
            const statusDiv = document.getElementById('login-status');

            if (username.length < 3 || password.length < 6) {
                statusDiv.textContent = 'Tên đăng nhập tối thiểu 3 ký tự, Mật khẩu tối thiểu 6 ký tự.';
                return;
            }

            const result = await window.apiCall('CREATE_ACCOUNT', { username, password });
            
            if (result && result.id) {
                statusDiv.textContent = 'Tạo tài khoản thành công! Bắt đầu game mới...';
                window.startGameSession(result.id, username, true); // true: game mới
            }
        };

        window.loadLoginScreen = function() {
            const loginContainer = document.getElementById('login-container');
            const gameContainer = document.getElementById('game-container');
            if (loginContainer && gameContainer) {
                loginContainer.classList.remove('hidden');
                gameContainer.classList.add('hidden');
            }
        }
        
        // Hàm mới để khởi động game sau khi đăng nhập thành công
        window.startGameSession = async function(id, username, isNew = false) {
            gameState.playerId = id; // Lưu ID người chơi vào gameState
            gameState.username = username;
            
            let loadedState = null;
            if (!isNew) {
                loadedState = await window.loadGame();
            }

            if (loadedState) {
                // Tải dữ liệu, chỉ ghi đè dữ liệu có thể thay đổi
                window.initializeConstants(); // Đảm bảo các constants được khởi tạo lại
                gameState = { ...gameState, ...loadedState }; 
                
                // Cập nhật lại các trường có thể bị thiếu từ phiên bản cũ
                gameState.npcInteractions = gameState.npcInteractions || initialGameState.npcInteractions;
                gameState.sectBenefits = gameState.sectBenefits || initialGameState.sectBenefits;
                gameState.cultivationMethod = CULTIVATION_METHODS.find(m => m.name === gameState.cultivationMethodName) || CULTIVATION_METHODS[0];
                
                window.logToConsole(`§TẢI THÀNH CÔNG: Chào mừng ${gameState.username}, tiếp tục Hành Trình Vô Thượng.`);
            } else {
                // Nếu không có dữ liệu lưu trữ, khởi tạo nhân vật mới
                window.initializeConstants(); 
                gameState = window.generateInitialStats({ ...initialGameState, username: username }); // Gán tên người dùng
                window.logToConsole("•KHỞI TẠO: Bắt đầu Hành Trình Vô Thượng từ Phàm Nhân.");
                window.saveGame(gameState); // Lưu lần đầu để tạo SaveData
            }

            // Generate daily item if missing (e.g. first load of the day)
            if (!gameState.dailyItem || (gameState.currentDay !== 1 && !SPECIAL_ITEMS.find(i => i.name === gameState.dailyItem.name))) {
                 window.generateDailySpecialItem();
            }

            // Sau khi tải/tạo xong, bắt đầu game
            window.finalizeInit();
            document.getElementById('player-id-value').textContent = `${gameState.username} (ID: ${id})`;
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
        };
    </script>

    <style>
        /* Custom Pixel Art Styling and Layout Fixes */
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --pixel-font: 'VT323', monospace;
            --primary-color: #3b82f6; /* Blue */
            --dark-bg: #1f2937; /* Gray 800 */
            --console-bg: #111827; /* Gray 900 */
            --border-color: #4b5563; /* Gray 600 */
        }

        body {
            font-family: var(--pixel-font);
            background-color: var(--dark-bg);
            color: #d1d5db;
        }

        .pixel-border {
            border: 4px solid var(--border-color);
            box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.5);
            border-radius: 0;
        }
        .pixel-card {
            border: 2px solid var(--border-color);
            padding: 8px;
        }

        /* --- BUTTON STYLING (Improved Hover/Active) --- */
        .game-button {
            font-size: 1.25rem;
            text-shadow: 2px 2px 0px rgba(0, 0, 0, 0.7);
            border: 3px solid #6ee7b7; /* Emerald 300 */
            background-color: #047857; /* Emerald 700 */
            transition: all 0.1s;
            line-height: 1;
            padding: 8px 12px;
            cursor: pointer;
            box-shadow: 2px 2px 0px #10b981;
        }

        .game-button:hover:not(:disabled) {
            background-color: #065f46;
            box-shadow: 4px 4px 0px #10b981;
            transform: translate(-2px, -2px);
        }

        .game-button:active:not(:disabled) {
            background-color: #059669;
            box-shadow: 0px 0px 0px #059669;
            transform: translate(0, 0);
        }
        
        .game-button:disabled {
             cursor: not-allowed;
             opacity: 0.6;
        }

        .tab-button {
             background-color: #374151; /* Gray 700 */
             border-bottom: 3px solid var(--border-color);
        }
        .tab-button.active {
             background-color: #4b5563; /* Gray 600 */
             border-bottom: 3px solid #fcd34d; /* Amber */
             color: #fcd34d;
        }


        /* --- CONSOLE AND PROGRESS BARS --- */
        #game-console {
            height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.2;
            padding: 1rem;
            background-color: var(--console-bg);
        }
        
        .progress-bar-hp, .progress-bar-exp, .progress-bar-monster-hp, .progress-bar-mp {
            background-color: #4b5563;
            height: 12px;
            border: 1px solid var(--border-color);
        }

        .progress-fill-hp {
            height: 100%;
            background-color: #ef4444; /* Red */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-exp {
            height: 100%;
            background-color: #3b82f6; /* Blue */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-monster-hp {
            height: 100%;
            background-color: #fcd34d; /* Amber/Yellow for Monster */
            transition: width 0.3s ease-in-out;
        }
        .progress-fill-mp {
            height: 100%;
            background-color: #9333ea; /* Purple for MP/Mana */
            transition: width 0.3s ease-in-out;
        }
        
        /* --- NEW STATS PANEL STYLING --- */
        .stat-group-header {
            font-size: 1.5rem;
            color: #fcd34d;
            border-bottom: 2px solid #4b5563;
            padding-bottom: 4px;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: 1.15rem;
        }
    </style>
</head>
<body class="p-4 flex justify-center items-center min-h-screen">
    
    <div id="login-container" class="w-full h-screen flex flex-col items-center justify-center bg-gray-900 absolute top-0 left-0" style="font-family: 'Pixel Art', monospace; z-index: 10;">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-sm pixel-border">
            <h2 class="text-3xl text-yellow-400 font-bold text-center mb-6 border-b-2 border-yellow-400 pb-2">THIÊN MỆNH CHI TỶ</h2>
            <div class="text-center text-sm text-gray-400 mb-4">Kết nối với Google Sheet Server</div>
            
            <input type="text" id="username-input" placeholder="Tên Đăng Nhập" class="w-full p-3 mb-4 bg-gray-700 text-white border border-gray-600 rounded focus:border-yellow-400 focus:outline-none">
            <input type="password" id="password-input" placeholder="Mật Khẩu" class="w-full p-3 mb-6 bg-gray-700 text-white border border-gray-600 rounded focus:border-yellow-400 focus:outline-none">
            
            <button onclick="window.handleActionLogin()" class="w-full game-button bg-yellow-600 hover:bg-yellow-700 font-bold py-3 rounded mb-3 transition duration-150 border-yellow-400 text-base">
                ĐĂNG NHẬP
            </button>
            
            <button onclick="window.handleActionCreateAccount()" class="w-full game-button bg-green-600 hover:bg-green-700 font-bold py-3 rounded transition duration-150 border-green-400 text-base">
                TẠO TÀI KHOẢN MỚI
            </button>
            
            <div id="login-status" class="text-center mt-4 text-red-400"></div>
        </div>
    </div>
    <div id="game-container" class="w-full max-w-6xl pixel-border bg-gray-800 p-6 hidden">
        <h1 class="text-4xl text-center mb-4 text-yellow-300">HÀNH TRÌNH VÔ THƯỢNG</h1>
        <p id="user-id-display" class="text-sm text-center mb-2 text-gray-500">ID Người Chơi: <span id="player-id-value">Chưa đăng nhập</span> | Chế độ: ONLINE (Google Sheet)</p>
        <p id="time-display" class="text-xl text-center mb-4 text-orange-400">Ngày: 1 | Tháng: 1</p>


        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div id="stats-panel" class="lg:col-span-1 flex flex-col space-y-4">
                
                <div class="pixel-card bg-gray-700 p-0">
                    <div id="character-art" class="bg-gray-900 h-48 flex justify-center items-center text-gray-500 text-xl font-bold border-b-4 border-gray-600">
                        Ảnh Nhân Vật (Sẽ cập nhật sau)
                    </div>
                    
                    <div class="p-4">
                        <h2 class="stat-group-header text-yellow-300">THÔNG TIN CƠ BẢN</h2>
                        <div class="stat-item">
                            <span>Cảnh Giới:</span> <span id="stat-realm" class="text-green-400 font-bold"></span>
                        </div>
                        <div class="stat-item">
                            <span>Linh Thạch:</span> <span id="stat-money" class="text-yellow-400 font-bold"></span>
                        </div>
                    </div>
                </div>

                <div class="pixel-card bg-gray-700">
                    <h2 class="stat-group-header text-red-400">CHỈ SỐ CHIẾN ĐẤU</h2>
                    
                    <div class="stat-item">
                        <span>Tấn Công:</span> <span id="stat-attack" class="text-red-400 font-bold">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Phòng Thủ:</span> <span id="stat-defense" class="text-blue-400 font-bold">0</span>
                    </div>
                    
                    <p class="mt-4 mb-1">HP: <span id="stat-hp" class="text-red-400">0/0</span></p>
                    <div class="progress-bar-hp">
                        <div id="hp-progress" class="progress-fill-hp" style="width: 100%"></div>
                    </div>
                    
                    <p class="mt-2 mb-1">Linh Khí (MP): <span id="stat-mp" class="text-purple-400">0/0</span></p>
                    <div class="progress-bar-mp">
                        <div id="mp-progress" class="progress-fill-mp" style="width: 100%"></div>
                    </div>
                </div>
                
                <div class="pixel-card bg-gray-700">
                    <h2 class="stat-group-header text-blue-400">THÔNG TIN TU LUYỆN</h2>
                    
                    <div class="stat-item">
                        <span>Linh Căn:</span> <span id="stat-spirit-root" class="text-purple-400 font-bold"></span>
                    </div>
                    <div class="stat-item">
                        <span>Căn Cốt:</span> <span id="stat-bone" class="text-orange-400 font-bold"></span>
                    </div>
                    <div class="stat-item mt-2">
                        <span>Công Pháp:</span> <span id="stat-cultivation-method" class="text-blue-300 font-bold"></span>
                    </div>

                    <div id="sect-info" class="mt-4 text-sm text-center"></div>
                </div>

                <div class="pixel-card bg-gray-700">
                    <h2 class="stat-group-header text-green-400">TIẾN TRÌNH TU VI</h2>
                    <p class="text-base mb-1">Tu Vi: <span id="stat-exp" class="text-blue-400">0</span></p>
                    <div class="progress-bar-exp">
                        <div id="exp-progress" class="progress-fill-exp" style="width: 0%"></div>
                    </div>
                    <button class="game-button p-2 text-base w-full mt-3" onclick="window.saveGame(gameState)">LƯU TRỮ TIẾN TRÌNH</button>
                </div>


            </div>

            <div class="lg:col-span-3 flex flex-col">
                <div id="main-tabs" class="grid grid-cols-5 gap-0 mb-0 border-b-4 border-gray-600">
                    <button id="tab-TuoXian" class="tab-button p-3 text-xl active" onclick="switchView('TuoXian')">TỌA THIỀN</button>
                    <button id="tab-Combat" class="tab-button p-3 text-xl" onclick="switchView('Combat')">CHIẾN ĐẤU</button>
                    <button id="tab-Trade" class="tab-button p-3 text-xl" onclick="switchView('Trade')">THƯƠNG HỘI</button>
                    <button id="tab-Sect" class="tab-button p-3 text-xl" onclick="switchView('Sect')">TÔNG MÔN</button>
                    <button id="tab-NPC" class="tab-button p-3 text-xl" onclick="switchView('NPC')">NPC</button>
                </div>

                <div id="main-content" class="min-h-72 pixel-border bg-gray-700 p-4 flex-grow">
                    </div>

                <div id="game-console" class="mt-4 pixel-border">
                    </div>
            </div>

        </div>
    </div>

    <script>
        // --- GAME DATA AND CONFIGURATION (NO CHANGE) ---
        const GAME_TICK_INTERVAL = 1000; // 1 second
        const DAY_DURATION_TICKS = 60; // 60 seconds = 1 day
        const TOURNAMENT_INTERVAL_DAYS = 6; // Tỷ Võ Tông Môn 6 ngày/lần

        // CĂN CỐT (Total Rarity of last 3 is 10%)
        const BONE_QUALITIES = [
            { name: "Phế Vật Cốt", multiplier: 0.5, breakthroughBonus: -0.10, hpBonus: 0.5, rarity: 15 },
            { name: "Phàm Cốt", multiplier: 1.0, breakthroughBonus: 0.00, hpBonus: 1.0, rarity: 25 },
            { name: "Linh Cốt", multiplier: 1.5, breakthroughBonus: 0.05, hpBonus: 1.5, rarity: 25 },
            { name: "Tiên Cốt", multiplier: 2.0, breakthroughBonus: 0.10, hpBonus: 2.0, rarity: 20 },
            { name: "Thần Cốt", multiplier: 3.0, breakthroughBonus: 0.15, hpBonus: 3.0, rarity: 5 }, // 5%
            { name: "Thiên Cốt (Vô Song)", multiplier: 4.0, breakthroughBonus: 0.20, hpBonus: 4.0, rarity: 3 }, // 3%
            { name: "Thánh Cốt (Cấm Kỵ)", multiplier: 5.0, breakthroughBonus: 0.25, hpBonus: 5.0, rarity: 1.5 }, // 1.5%
            { name: "Hỗn Độn Cốt (Tuyệt Thế)", multiplier: 6.0, breakthroughBonus: 0.30, hpBonus: 6.0, rarity: 0.5 }, // 0.5%
        ];
        
        // LINH CĂN (Total Rarity of last 3 is 10%)
        const SPIRIT_ROOTS = [
            { name: "Phế Linh Căn", multiplier: 0.5, mpBonus: 0.5, mpRegen: 0.5, rarity: 15 },
            { name: "Ngũ Hành Căn", multiplier: 1.0, mpBonus: 1.0, mpRegen: 1.0, rarity: 25 },
            { name: "Biến Dị Căn (Phong/Lôi)", multiplier: 1.5, mpBonus: 1.5, mpRegen: 1.5, rarity: 25 },
            { name: "Đơn Linh Căn (Hoàn Mỹ)", multiplier: 2.5, mpBonus: 2.5, mpRegen: 2.0, rarity: 20 },
            { name: "Thiên Linh Căn", multiplier: 4.0, mpBonus: 4.0, mpRegen: 3.0, rarity: 5 }, // 5%
            { name: "Huyền Băng Căn (Hiếm)", multiplier: 5.0, mpBonus: 5.0, mpRegen: 4.0, rarity: 3 }, // 3%
            { name: "Thái Dương Căn (Cực Hiếm)", multiplier: 6.0, mpBonus: 6.0, mpRegen: 5.0, rarity: 1.5 }, // 1.5%
            { name: "Hỗn Độn Căn (Vô Thượng)", multiplier: 8.0, mpBonus: 8.0, mpRegen: 6.0, rarity: 0.5 }, // 0.5%
        ];

        // CÔNG PHÁP MỚI
        const CULTIVATION_METHODS = [
            { name: "Thái Huyền Kiếm Quyết", bonus: { atk: 10, expMultiplier: 1.0 }, cost: 0, description: "Tăng 10 Tấn Công, Tốc độ Tu Vi x1.0." },
            { name: "Vạn Pháp Quy Nguyên Công", bonus: { def: 10, expMultiplier: 1.0 }, cost: 0, description: "Tăng 10 Phòng Thủ, Tốc độ Tu Vi x1.0." },
            { name: "Huyết Sát Ma Kinh", bonus: { atk: 25, hp: 0.1, expMultiplier: 0.8 }, cost: 50000, description: "Tăng 25 Tấn Công, 10% Max HP. Tốc độ Tu Vi x0.8. (50,000 LT)." },
            { name: "Thanh Mộc Trường Sinh Quyết", bonus: { hp: 0.2, def: 5, expMultiplier: 1.2 }, cost: 75000, description: "Tăng 20% Max HP, 5 Phòng Thủ. Tốc độ Tu Vi x1.2. (75,000 LT)." },
            { name: "Kim Cương Bất Hoại", bonus: { def: 30, expMultiplier: 0.9 }, cost: 100000, description: "Tăng 30 Phòng Thủ. Tốc độ Tu Vi x0.9. (100,000 LT)." },
            { name: "Vô Thượng Thiên Công", bonus: { atk: 50, def: 50, expMultiplier: 1.5 }, cost: 100, isSectSkill: true, sectContribution: 10000, description: "Chỉ số toàn diện. Cần Cống Hiến Tông Môn 10,000." },
        ];


        const REALMS = [
            { name: "Phàm Nhân", maxExp: 1000, color: "text-gray-400", baseDmg: 5, baseDef: 0 },
            { name: "Luyện Khí Tầng 1", maxExp: 2500, color: "text-yellow-400", baseDmg: 15, baseDef: 5 },
            { name: "Luyện Khí Tầng 2", maxExp: 5000, color: "text-yellow-400", baseDmg: 25, baseDef: 10 },
            { name: "Luyện Khí Tầng 3", maxExp: 8000, color: "text-yellow-400", baseDmg: 35, baseDef: 15 },
            { name: "Trúc Cơ Sơ Kỳ", maxExp: 15000, color: "text-green-400", baseDmg: 60, baseDef: 25 },
            { name: "Trúc Cơ Trung Kỳ", maxExp: 30000, color: "text-green-400", baseDmg: 90, baseDef: 40 },
            { name: "Kim Đan Sơ Kỳ", maxExp: 60000, color: "text-red-400", baseDmg: 150, baseDef: 70 },
            { name: "Kim Đan Trung Kỳ", maxExp: 100000, color: "text-red-400", baseDmg: 200, baseDef: 100 },
            { name: "Nguyên Anh Sơ Kỳ", maxExp: 200000, color: "text-purple-400", baseDmg: 350, baseDef: 180 },
            { name: "Nguyên Anh Trung Kỳ", maxExp: 400000, color: "text-purple-400", baseDmg: 500, baseDef: 250 },
            { name: "Hóa Thần Sơ Kỳ", maxExp: 800000, color: "text-indigo-400", baseDmg: 700, baseDef: 350 },
            { name: "Hóa Thần Trung Kỳ", maxExp: 1500000, color: "text-indigo-400", baseDmg: 1000, baseDef: 500 },
            { name: "Luyện Hư", maxExp: 3000000, color: "text-pink-400", baseDmg: 1500, baseDef: 750 },
            { name: "Hợp Thể", maxExp: 6000000, color: "text-pink-400", baseDmg: 2500, baseDef: 1000 },
            { name: "Đại Thừa", maxExp: 12000000, color: "text-cyan-400", baseDmg: 4000, baseDef: 1500 },
            { name: "Độ Kiếp (Cực Hạn)", maxExp: 999999999, color: "text-yellow-100", baseDmg: 6000, baseDef: 2500 },
        ];
        
        const SKILLS = [
            { name: "Đột Kích (Cơ bản)", damageMultiplier: 1.5, mpCost: 20, description: "Gây 150% sát thương, tốn 20 MP." }
        ];

        const MONSTERS = [
            { id: 0, name: "Linh Xà Độc", minRealm: 0, requiredRealm: "Phàm Nhân", baseHp: 50, baseAtk: 5, exp: 100, loot: { 'Yêu Thú Tàn Thi': 1.0, 'Bình Phàm Đan': 0.1 } },
            { id: 1, name: "Hắc Báo Y", minRealm: 2, requiredRealm: "Luyện Khí Tầng 2", baseHp: 150, baseAtk: 15, exp: 300, loot: { 'Yêu Thú Tàn Thi': 0.7, 'Hắc Báo Bì': 0.5, 'Linh Căn Thảo': 0.05 } },
            { id: 2, name: "Phi Thiên Hổ", minRealm: 4, requiredRealm: "Trúc Cơ Sơ Kỳ", baseHp: 500, baseAtk: 40, exp: 1000, loot: { 'Linh Thú Cốt': 0.7, 'Thiên Lang Đan': 0.2, 'Kim Tinh Thạch': 0.01 } },
            { id: 3, name: "Tứ Giai Ma Thú", minRealm: 7, requiredRealm: "Kim Đan Sơ Kỳ", baseHp: 1200, baseAtk: 80, exp: 2500, loot: { 'Ma Thú Huyết': 0.8, 'Huyền Thiết': 0.3, 'Bí Pháp Quyển': 0.005, 'Long Lân': 0.001 } }, // Đồ hiếm 0.1%
            { id: 4, name: "Thượng Cổ Ma Long", minRealm: 10, requiredRealm: "Nguyên Anh Sơ Kỳ", baseHp: 5000, baseAtk: 200, exp: 8000, loot: { 'Long Lân': 0.9, 'Nội Đan': 0.5, 'Thiên Thần Đan': 0.005 } }, // Đồ hiếm 0.5%
            { id: 5, name: "Cửu Vỹ Hồ Ly", minRealm: 13, requiredRealm: "Luyện Hư", baseHp: 15000, baseAtk: 500, exp: 30000, loot: { 'Hồ Yêu Nội Đan': 1.0, 'Huyền Thiết': 0.5, 'Tử Kim Linh Thạch': 0.05 } }, // Đồ hiếm 5%
        ];

        // PHÓ BẢN MỚI
        const DUNGEONS = [
            { id: 'ancient_tomb', name: "Cổ Mộ Tiên Tôn", requiredRealm: "Trúc Cơ Trung Kỳ", realmIndex: 5, reward: 20000, exp: 5000, baseHp: 3000, baseAtk: 150, loot: { 'Tử Kim Linh Thạch': 0.1, 'Bí Pháp Quyển': 0.5 } },
            { id: 'demon_realm', name: "Ma Giới Liệt Kê", requiredRealm: "Kim Đan Trung Kỳ", realmIndex: 8, reward: 50000, exp: 15000, baseHp: 10000, baseAtk: 400, loot: { 'Thiên Thần Đan': 0.1, 'Tử Kim Linh Thạch': 0.5 } },
        ];

        const LOOT_PRICES = {
            'Yêu Thú Tàn Thi': { price: 20, type: 'common' },
            'Bình Phàm Đan': { price: 50, type: 'common' },
            'Hắc Báo Bì': { price: 80, type: 'common' },
            'Linh Căn Thảo': { price: 300, type: 'common' },
            'Linh Thú Cốt': { price: 150, type: 'common' },
            'Thiên Lang Đan': { price: 500, type: 'common' },
            'Ma Thú Huyết': { price: 400, type: 'common' },
            'Huyền Thiết': { price: 1000, type: 'common' },
            'Kim Tinh Thạch': { price: 5000, type: 'rare' }, 
            'Bí Pháp Quyển': { price: 15000, type: 'rare' },
            'Long Lân': { price: 8000, type: 'rare' },
            'Nội Đan': { price: 20000, type: 'rare' },
            'Hồ Yêu Nội Đan': { price: 50000, type: 'rare' },
            'Thiên Thần Đan': { price: 100000, type: 'super_rare' },
            'Tử Kim Linh Thạch': { price: 500000, type: 'super_rare' },
            // VẬT PHẨM MỚI: Tỷ lệ rơi 1% (0.01)
            'Thiên Phạt Lệnh': { price: 100000, type: 'super_rare' }, 
        };

        const TRADE_ITEMS = [
            { name: "Linh Khí Phù", price: 100, bonus: 500, type: "exp", description: "Tăng 500 Tu Vi." },
            { name: "Giáp Da Thú", price: 200, bonus: 10, type: "def", description: "Tăng 10 điểm Phòng Thủ vĩnh viễn." },
            { name: "Trúc Cơ Đan", price: 5000, bonus: 1, type: "breakthrough", description: "Đảm bảo đột phá thành công cảnh giới hiện tại." },
        ];
        
        // Items for Daily Shop Special & Monthly Auction
        const SPECIAL_ITEMS = [
            { name: "Hồi Lực Đan", price: 500, type: "mp", bonus: 50, description: "Hồi 50 Linh Khí (MP)." },
            { name: "Trúc Nhan Đan", price: 1000, type: "hp", bonus: 0.5, description: "Tăng 0.5% HP Tối Đa vĩnh viễn (Tính theo cấp độ)." },
            { name: "Tấn Công Phù", price: 2000, type: "atk", bonus: 20, description: "Tăng 20 điểm Tấn Công vĩnh viễn." },
        ];

        const AUCTION_ITEMS = [
            { name: "Cải Cốt Đan", basePrice: 50000, type: "bone_change", description: "Cơ hội cải tạo Căn Cốt cao hơn (Cực Hiếm)." },
            { name: "Tẩy Tủy Đan", basePrice: 80000, type: "root_change", description: "Cơ hội cải tạo Linh Căn cao hơn (Cực Hiếm)." },
            { name: "Thần Binh Phù", basePrice: 150000, type: "atk_mega", bonus: 100, description: "Tăng 100 điểm Tấn Công vĩnh viễn (Siêu phẩm)." },
        ];
        
        const MOCK_NPCS = [
            { id: 'thanhvan', name: "Sư Tỷ Thanh Vân", realm: "Luyện Khí Tầng 3", baseAtk: 50, baseDef: 20, baseHp: 300, isChallengable: false, description: "Bận rộn luyện đan, có thể chỉ điểm công pháp." },
            { id: 'truonglao', name: "Trưởng Lão Dược Các", realm: "Trúc Cơ Trung Kỳ", baseAtk: 100, baseDef: 50, baseHp: 800, isChallengable: false, description: "Người quản lý vật phẩm hiếm, có thể trao đổi bảo vật." },
            { 
                id: 'thientai', 
                name: "Thiên Tài Huyền Băng", 
                realm: "Kim Đan Sơ Kỳ", 
                baseAtk: 200, 
                baseDef: 100, 
                baseHp: 1500, 
                isChallengable: true, 
                reward: 10000, 
                description: "Tu Giả kiêu ngạo, có thể thách đấu để nhận thưởng lớn.",
                loot: { 'Thiên Phạt Lệnh': 0.001 } // Tỷ lệ rơi 0.1%
            },
            { 
                id: 'sugia', 
                name: "Sư Già Tiền Bối", 
                realm: "Nguyên Anh Hậu Kỳ", 
                baseAtk: 500, 
                baseDef: 250, 
                baseHp: 5000, 
                isChallengable: true, 
                reward: 50000, 
                description: "Cao nhân ẩn dật, có thể thách đấu để nhận thưởng khủng.",
                loot: { 'Thiên Phạt Lệnh': 0.01 } // Tỷ lệ rơi 1% theo yêu cầu
            }
        ];
        
        const SECTS = [
            { name: "Thái Huyền Kiếm Tông", expBonus: 1.1, defBonus: 10, requirement: 3 }, // Luyện Khí 3
            { name: "Vạn Pháp Các", expBonus: 1.2, defBonus: 5, requirement: 5 }, // Trúc Cơ Sơ Kỳ
            { name: "Huyết Ma Giáo", expBonus: 1.0, defBonus: 20, requirement: 7 }, // Kim Đan Sơ Kỳ
        ];


        // --- GAME STATE (Initial Values for New Game) ---
        const initialGameState = {
            username: '', // Sẽ được gán tên người dùng
            realmIndex: 0,
            experience: 0,
            spiritStone: 100, 
            currentHP: 100,
            maxHP: 100,
            currentMP: 50, // Initial MP
            maxMP: 50,     // Initial Max MP
            mpRegenRate: 1, // Initial Regen
            baseAttack: 10,
            baseDefense: 5,
            spiritRoot: null, 
            boneQuality: null, 
            spiritRootName: null, 
            boneQualityName: null, 
            cultivationMethodName: CULTIVATION_METHODS[0].name, // Lưu tên
            cultivationMethod: CULTIVATION_METHODS[0], // Lưu toàn bộ data
            inventory: { 
                'Yêu Thú Tàn Thi': 0, 
                'Bình Phàm Đan': 0, 
                'Hắc Báo Bì': 0, 
                'Kim Tinh Thạch': 0, 
                'Bí Pháp Quyển': 0, 
                'Trúc Cơ Đan': 0, 
                'Linh Căn Thảo': 0,
                'Thiên Phạt Lệnh': 0 
            },
            currentView: 'TuoXian',
            currentMonster: null, 
            currentNPCCombat: null, 
            
            // Time & Shop States
            currentDay: 1, 
            lastAuctionDay: 0,
            dailyItem: null,

            // NPC interaction states
            npcInteractions: {
                thanhvan_advice_atk: false,
                sugia_advice_def: false
            },

            // SECT SYSTEM STATES
            sectName: null, // Tên tông môn đang tham gia
            sectRank: 'Phổ Thông Đệ Tử',
            sectContribution: 0, // Cống hiến tông môn
            sectBenefits: { expBonus: 1.0, defBonus: 0 },
            lastTournamentDay: 0, // Ngày cuối cùng diễn ra tỷ võ
            currentCombatMode: 'Wilderness' // 'Wilderness' or 'Dungeon'

        };

        let gameState = {}; // State will be loaded/initialized here

        let tuXianInterval = null;
        let combatInterval = null;
        let npcCombatInterval = null;
        let healthRegenInterval = null;
        let timeTickInterval = null;
        let selectedNPC = null; 
        let gameTicks = 0; // for day tracking


        // --- CORE GAME FUNCTIONS ---
        
        window.logToConsole = function(message) {
            const consoleElement = document.getElementById('game-console');
            let logMessage = `<p class="text-sm my-1">${message}</p>`;

            if (message.startsWith("§")) {
                logMessage = `<p class="text-base my-1 font-bold text-yellow-300">${message.substring(1)}</p>`;
            } else if (message.startsWith("•")) {
                logMessage = `<p class="text-sm my-1 text-green-400">${message}</p>`;
            } else if (message.startsWith("X")) {
                 logMessage = `<p class="text-sm my-1 text-red-500">${message.substring(1)}</p>`;
            } else if (message.startsWith("!")) {
                 logMessage = `<p class="text-sm my-1 text-purple-400">${message.substring(1)}</p>`;
            }

            consoleElement.innerHTML += logMessage;
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        // --- INITIALIZATION & GAME START ---

        function pickRandomStat(statList) {
            const totalRarity = statList.reduce((sum, s) => sum + s.rarity, 0);
            let rand = Math.random() * totalRarity;
            for (const stat of statList) {
                if (rand < stat.rarity) {
                    return stat;
                }
                rand -= stat.rarity;
            }
            return statList[0]; // Fallback
        }

        window.generateInitialStats = function(state) {
            const root = pickRandomStat(SPIRIT_ROOTS);
            const bone = pickRandomStat(BONE_QUALITIES);

            state.spiritRoot = root.multiplier;
            state.spiritRootName = root.name;
            state.boneQuality = bone.multiplier;
            state.boneQualityName = bone.name;
            
            // Random initial method from the non-sect list
            const initialMethods = CULTIVATION_METHODS.filter(m => !m.isSectSkill);
            const initialMethod = initialMethods[Math.floor(Math.random() * initialMethods.length)];
            state.cultivationMethodName = initialMethod.name;
            state.cultivationMethod = initialMethod;

            return state;
        }
        
        // Hàm này không còn tải game, chỉ khởi tạo các constants
        window.initializeConstants = function() {
            // Khởi tạo lại game state nếu cần
            gameState = { ...initialGameState, playerId: gameState.playerId, username: gameState.username }; 
        }

        // Main function to start the game
        window.onload = function() {
            window.loadLoginScreen();
        };

        // Hàm này không còn cần thiết vì startGameSession đảm nhiệm việc tải
        // window.startGame = function() { 
        //     window.loadLoginScreen(); 
        // };

        window.finalizeInit = function() {
            if (tuXianInterval) clearInterval(tuXianInterval);
            if (combatInterval) clearInterval(combatInterval);
            if (npcCombatInterval) clearInterval(npcCombatInterval);
            if (healthRegenInterval) clearInterval(healthRegenInterval);
            if (timeTickInterval) clearInterval(timeTickInterval);
            
            calculateStats();
            updateUI();
            startTuoXianLoop();
            startRegenLoop(); 
            startTimeTick();
            switchView(gameState.currentView || 'TuoXian');
        }

        function calculateStats() {
            const currentRealm = REALMS[gameState.realmIndex];
            const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
            const rootStat = SPIRIT_ROOTS.find(r => r.name === gameState.spiritRootName);
            const method = gameState.cultivationMethod;
            
            // Base Stats
            let newMaxHP = 100 + (gameState.realmIndex * 250) + (boneStat?.hpBonus || 1) * 100;
            let newBaseAttack = currentRealm.baseDmg + Math.floor(gameState.realmIndex * 15);
            let newBaseDefense = currentRealm.baseDef + Math.floor(gameState.realmIndex * 10);
            
            // Apply Method Bonus
            if (method.bonus.atk) newBaseAttack += method.bonus.atk;
            if (method.bonus.def) newBaseDefense += method.bonus.def;
            if (method.bonus.hp) newMaxHP += newMaxHP * method.bonus.hp;

            // Apply Sect Bonus
            newBaseDefense += gameState.sectBenefits.defBonus;

            // HP
            gameState.maxHP = Math.floor(newMaxHP);
            gameState.currentHP = Math.min(gameState.currentHP, gameState.maxHP);

            // MP
            gameState.maxMP = 50 + (gameState.realmIndex * 100) + (rootStat?.mpBonus || 1) * 50;
            gameState.currentMP = Math.min(gameState.currentMP, gameState.maxMP);
            gameState.mpRegenRate = (rootStat?.mpRegen || 1) * 2; // Base 2 MP/tick

            // ATK/DEF
            gameState.baseAttack = newBaseAttack;
            gameState.baseDefense = newBaseDefense;
            updateUI();
        }

        function updateUI() {
            const currentRealm = REALMS[gameState.realmIndex];
            const nextRealmMaxExp = currentRealm.maxExp;
            const currentExp = gameState.experience;
            const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
            
            // Time Display
            const currentMonth = Math.floor(gameState.currentDay / 30) + 1;
            const dayInMonth = (gameState.currentDay % 30) || 30;
            document.getElementById('time-display').textContent = `Ngày: ${dayInMonth} | Tháng: ${currentMonth}`;

            // Stats Panel Updates
            document.getElementById('stat-realm').textContent = currentRealm.name;
            document.getElementById('stat-money').textContent = gameState.spiritStone.toLocaleString();
            document.getElementById('stat-spirit-root').textContent = `${gameState.spiritRootName} (x${gameState.spiritRoot})`;
            document.getElementById('stat-bone').textContent = `${gameState.boneQualityName} (HP x${boneStat?.hpBonus || 1})`;
            document.getElementById('stat-cultivation-method').textContent = gameState.cultivationMethodName;

            // Sect Info Update
            const sectInfoElement = document.getElementById('sect-info');
            if (gameState.sectName) {
                sectInfoElement.innerHTML = `
                 <p class="text-sm text-center border-t border-gray-500 pt-2 text-purple-300">
                  Tông Môn: <span class="text-yellow-300 font-bold">${gameState.sectName}</span><br>
                  Chức Vụ: <span class="text-green-400 font-bold">${gameState.sectRank}</span><br>
                  Cống Hiến: <span class="text-yellow-400 font-bold">${gameState.sectContribution.toLocaleString()}</span>
                 </p>
                 `;
            } else {
                sectInfoElement.innerHTML = "<p class='text-sm text-center border-t border-gray-500 pt-2 text-gray-500'>Chưa gia nhập Tông Môn.</p>";
            }

            document.getElementById('stat-attack').textContent = gameState.baseAttack;
            document.getElementById('stat-defense').textContent = gameState.baseDefense;
            document.getElementById('stat-hp').textContent = `${gameState.currentHP.toFixed(0)} / ${gameState.maxHP.toFixed(0)}`;
            document.getElementById('stat-mp').textContent = `${gameState.currentMP.toFixed(0)} / ${gameState.maxMP.toFixed(0)} (Hồi: +${gameState.mpRegenRate}/tick)`;

            // Progress Bars
            const expProgress = Math.min(100, (currentExp / nextRealmMaxExp) * 100);
            document.getElementById('stat-exp').textContent = `${currentExp.toLocaleString()} / ${nextRealmMaxExp.toLocaleString()}`;
            document.getElementById('exp-progress').style.width = `${expProgress}%`;

            const hpProgress = (gameState.currentHP / gameState.maxHP) * 100;
            document.getElementById('hp-progress').style.width = `${hpProgress}%`;
            
            const mpProgress = (gameState.currentMP / gameState.maxMP) * 100;
            document.getElementById('mp-progress').style.width = `${mpProgress}%`;


            // Rerender combat/trade specific UI if needed
            if (['Combat', 'NPC', 'Trade', 'Sect'].includes(gameState.currentView)) {
                renderView(gameState.currentView);
            }
        }

        // --- TIME AND REGEN LOOPS ---
        function startTimeTick() {
            if (timeTickInterval) clearInterval(timeTickInterval);
            timeTickInterval = setInterval(gameTick, GAME_TICK_INTERVAL);
        }

        function gameTick() {
            gameTicks++;

            // MP Regen
            if (gameState.currentMP < gameState.maxMP) {
                gameState.currentMP = Math.min(gameState.maxMP, gameState.currentMP + gameState.mpRegenRate);
            }

            // Day Change
            if (gameTicks % DAY_DURATION_TICKS === 0) {
                gameState.currentDay++;
                window.logToConsole(`!NHẬT KÝ: Hôm nay là Ngày ${gameState.currentDay % 30 || 30} (Tháng ${Math.floor(gameState.currentDay / 30) + 1}).`);
                
                // Monthly Auction Check (Day 30 of the month, and only once per month)
                if (gameState.currentDay % 30 === 0 && gameState.currentDay > gameState.lastAuctionDay) {
                    window.startMonthlyAuction();
                }

                // Sect Tournament Check (Every 6 days)
                if ((gameState.currentDay % TOURNAMENT_INTERVAL_DAYS === 0) && gameState.currentDay > gameState.lastTournamentDay && gameState.sectName) {
                    window.handleTournament();
                }

                // Generate new Daily Shop Item
                window.generateDailySpecialItem();
            }
            updateUI();
        }

        function handleTournament() {
            gameState.lastTournamentDay = gameState.currentDay;
            window.logToConsole(`§TÔNG MÔN TỶ VÕ: **${gameState.sectName}** tổ chức Tỷ Võ!`);
            
            // Simplified Tournament Logic: Player wins 10% of the time
            if (Math.random() < 0.1) {
                const reward = 100000;
                gameState.spiritStone += reward;
                gameState.sectContribution += 5000;
                window.logToConsole(`§TÔNG MÔN TỶ VÕ: Bạn đã giành chiến thắng! Nhận **${reward.toLocaleString()} Linh Thạch** và **5,000 Cống Hiến**!`);
            } else {
                window.logToConsole(`•TÔNG MÔN TỶ VÕ: Bạn không giành được thứ hạng cao. Cần tu luyện thêm.`);
            }
            window.saveGame(gameState);
        }

        function startRegenLoop() {
            if (healthRegenInterval) clearInterval(healthRegenInterval);
            healthRegenInterval = setInterval(() => {
                // Chỉ hồi phục khi không chiến đấu và HP chưa đầy
                if (gameState.currentHP < gameState.maxHP && !combatInterval && !npcCombatInterval) {
                    const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
                    const healRate = 0.05 * (boneStat?.multiplier || 1.0);
                    const heal = Math.ceil(gameState.maxHP * healRate);
                    gameState.currentHP = Math.min(gameState.maxHP, gameState.currentHP + heal);
                    updateUI();
                }
            }, 5000);
        }
        
        // --- TU LUYEN (TuoXian) ---
        function startTuoXianLoop() {
            if (tuXianInterval) clearInterval(tuXianInterval);
            tuXianInterval = setInterval(tuXian, 1000); // Tích lũy mỗi giây
        }

        function tuXian() {
            if (gameState.currentView !== 'TuoXian') return;

            const currentRealm = REALMS[gameState.realmIndex];
            if (gameState.realmIndex >= REALMS.length - 1) return; // Max Realm

            const rootMultiplier = gameState.spiritRoot; // Linh Căn multiplier
            const methodMultiplier = gameState.cultivationMethod.bonus.expMultiplier || 1.0;
            const sectMultiplier = gameState.sectBenefits.expBonus || 1.0;

            let expGain = Math.floor(10 * rootMultiplier * methodMultiplier * sectMultiplier);

            // Giới hạn Exp Gain theo Realm (Linh Khí trong không khí loãng dần)
            expGain = Math.max(1, expGain - (gameState.realmIndex * 5)); 
            
            // Tăng Tu Vi
            gameState.experience += expGain;

            // Kiểm tra đột phá
            if (gameState.experience >= currentRealm.maxExp) {
                window.renderView('TuoXian'); // Cập nhật ngay màn hình để hiển thị nút
            }

            updateUI();
        }

        window.handleActionBreakthrough = function() {
            const currentRealm = REALMS[gameState.realmIndex];
            const nextRealm = REALMS[gameState.realmIndex + 1];
            if (!nextRealm) {
                window.logToConsole("§CHÚC MỪNG: Đã đạt đến Cảnh Giới Vô Thượng (Độ Kiếp). Không thể đột phá thêm.");
                return;
            }

            // Tính tỷ lệ thành công cơ bản (20% - 70%)
            let successRate = 0.2 + (gameState.realmIndex * 0.05); // Tăng 5% mỗi cấp
            successRate = Math.min(0.7, successRate);
            
            // Căn Cốt tác động đến tỷ lệ đột phá
            const boneStat = BONE_QUALITIES.find(b => b.name === gameState.boneQualityName);
            successRate += (boneStat?.breakthroughBonus || 0);

            // Kiểm tra Trúc Cơ Đan
            const usePill = gameState.inventory['Trúc Cơ Đan'] > 0;
            if (usePill) {
                successRate = 1.0; // Đảm bảo thành công 100%
            }


            window.logToConsole(`!ĐỘT PHÁ: Đang thử đột phá từ ${currentRealm.name} lên ${nextRealm.name}... Tỷ lệ thành công: ${(successRate * 100).toFixed(1)}%`);

            if (Math.random() < successRate) {
                // Thành công
                gameState.realmIndex++;
                gameState.experience = 0;
                gameState.currentHP = gameState.maxHP; // Hồi phục hoàn toàn khi đột phá
                gameState.currentMP = gameState.maxMP; 
                window.logToConsole(`§CHÚC MỪNG: Đột phá thành công! Bước vào Cảnh Giới **${nextRealm.name}**!`);
                if (usePill) gameState.inventory['Trúc Cơ Đan']--;
                window.saveGame(gameState);
            } else {
                // Thất bại (Mất Tu Vi và giảm HP)
                const expLoss = Math.floor(currentRealm.maxExp * 0.1); // Mất 10% exp
                gameState.experience = Math.max(0, gameState.experience - expLoss);
                gameState.currentHP = Math.max(1, gameState.currentHP * 0.5); // Giảm 50% HP
                window.logToConsole(`XTHẤT BẠI: Đột phá thất bại! Mất ${expLoss.toLocaleString()} Tu Vi và bị trọng thương (Giảm 50% HP).`);
            }
            
            updateUI();
            window.renderView('TuoXian'); // Cập nhật lại màn hình
        }

        // --- COMBAT --- (Existing code remains the same)
        function getAvailableMonsters() {
            // ...
        }
        
        // ... (rest of the Combat logic)
        
        // --- TRADE ---
        window.generateDailySpecialItem = function() {
            const availableItems = SPECIAL_ITEMS;
            gameState.dailyItem = availableItems[Math.floor(Math.random() * availableItems.length)];
            window.logToConsole(`!THƯƠNG HỘI: Vật phẩm Đặc Biệt Hôm Nay là **${gameState.dailyItem.name}**.`);
        }

        window.startMonthlyAuction = function() {
            gameState.lastAuctionDay = gameState.currentDay;
            const auctionItem = AUCTION_ITEMS[Math.floor(Math.random() * AUCTION_ITEMS.length)];
            const finalPrice = auctionItem.basePrice; 
            gameState.auction = { item: auctionItem.name, price: finalPrice };
            
            window.logToConsole(`§ĐẤU GIÁ: Phiên Đấu Giá Tháng Bắt Đầu! Vật phẩm: **${auctionItem.name}** - Giá Khởi Điểm: ${finalPrice.toLocaleString()} Linh Thạch.`);
            window.renderView('Trade');
        }

        // ... (rest of the Trade logic)

        // --- SECT ---
        window.handleJoinSect = function(sectIndex) {
            // ... (rest of the Sect logic)
        }

        // ... (rest of the Sect logic)
        
        // --- NPC ---
        // ... (rest of the NPC logic)


        // --- VIEW RENDERING (HTML) ---
        function renderTuoXian() {
            // ... (rest of the renderTuoXian logic)
        }
        
        // ... (rest of the rendering functions)

        window.renderView = function(viewName) {
            // ... (rest of the renderView logic)
        }

        // CÁC HÀM CŨ TỪ PHIÊN BẢN TRƯỚC VẪN GIỮ NGUYÊN (NHƯ switchView, renderCombat, etc.)
        // VÀ SẼ ĐƯỢC BẢO TOÀN TRONG CODE CỦA BẠN.
    </script>
</body>
</html>
